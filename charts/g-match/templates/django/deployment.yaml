apiVersion: apps/v1
kind: Deployment
metadata:
  name: g-match-web
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "g-match.labels" . | nindent 4 }}
    app: g-match
    component: web
spec:
  replicas: {{ .Values.django.replicas }}
  selector:
    matchLabels:
      app: g-match
      component: web
  template:
    metadata:
      labels:
        app: g-match
        component: web
    spec:
      {{- include "g-match.nodeAffinity" . | nindent 6 }}
      {{- include "g-match.imagePullSecrets" . | nindent 6 }}
      initContainers:
      # Wait for MySQL to be ready
      - name: wait-for-mysql
        image: {{ .Values.initContainers.busybox.image }}:{{ .Values.initContainers.busybox.tag }}
        command:
        - sh
        - -c
        - |
          until nc -z {{ .Values.mysql.serviceName }} {{ .Values.mysql.port }}; do
            echo "Waiting for MySQL..."
            sleep 2
          done
          echo "MySQL is ready"
        resources:
          {{- toYaml .Values.initContainers.busybox.resources | nindent 10 }}

      # Wait for Redis to be ready
      - name: wait-for-redis
        image: {{ .Values.initContainers.busybox.image }}:{{ .Values.initContainers.busybox.tag }}
        command:
        - sh
        - -c
        - |
          until nc -z {{ .Values.redis.serviceName }} {{ .Values.redis.port }}; do
            echo "Waiting for Redis..."
            sleep 2
          done
          echo "Redis is ready"
        resources:
          {{- toYaml .Values.initContainers.busybox.resources | nindent 10 }}

      # Copy migrations from PV to shared emptyDir
      - name: copy-migrations
        image: {{ .Values.initContainers.busybox.image }}:{{ .Values.initContainers.busybox.tag }}
        command:
        - sh
        - -c
        - |
          echo "Copying migrations from PV to shared volume..."
          mkdir -p /shared-migrations/account
          mkdir -p /shared-migrations/match
          if [ -d /migrations-pv/account ] && [ "$(ls -A /migrations-pv/account 2>/dev/null)" ]; then
            cp -r /migrations-pv/account/* /shared-migrations/account/
            echo "account migrations copied: $(ls /shared-migrations/account/)"
          else
            echo "No account migrations in PV, creating __init__.py"
            touch /shared-migrations/account/__init__.py
          fi
          if [ -d /migrations-pv/match ] && [ "$(ls -A /migrations-pv/match 2>/dev/null)" ]; then
            cp -r /migrations-pv/match/* /shared-migrations/match/
            echo "match migrations copied: $(ls /shared-migrations/match/)"
          else
            echo "No match migrations in PV, creating __init__.py"
            touch /shared-migrations/match/__init__.py
          fi
          echo "Migrations sync complete"
        volumeMounts:
        - name: migrations-storage
          mountPath: /migrations-pv
          readOnly: true
        - name: shared-migrations
          mountPath: /shared-migrations
        resources:
          {{- toYaml .Values.initContainers.busybox.resources | nindent 10 }}

      # Collect static files
      - name: django-collectstatic
        image: {{ include "g-match.django.image" . }}
        imagePullPolicy: {{ .Values.image.django.pullPolicy }}
        command:
        - python
        - manage.py
        - collectstatic
        - --noinput
        envFrom:
        - configMapRef:
            name: g-match-config
        - secretRef:
            name: g-match-secret
        volumeMounts:
        - name: static-files
          mountPath: {{ .Values.config.staticRoot }}
        - name: shared-migrations
          mountPath: /app/account/migrations
          subPath: account
        - name: shared-migrations
          mountPath: /app/match/migrations
          subPath: match
        resources:
          {{- toYaml .Values.django.collectstatic.resources | nindent 10 }}

      containers:
      - name: django
        image: {{ include "g-match.django.image" . }}
        imagePullPolicy: {{ .Values.image.django.pullPolicy }}
        ports:
        - containerPort: {{ .Values.django.port }}
          name: http
        envFrom:
        - configMapRef:
            name: g-match-config
        - secretRef:
            name: g-match-secret
        volumeMounts:
        - name: static-files
          mountPath: /app/staticfiles
        - name: shared-migrations
          mountPath: /app/account/migrations
          subPath: account
        - name: shared-migrations
          mountPath: /app/match/migrations
          subPath: match
        livenessProbe:
          httpGet:
            path: {{ .Values.django.livenessProbe.path }}
            port: {{ .Values.django.port }}
            httpHeaders:
            - name: Host
              value: localhost
          initialDelaySeconds: {{ .Values.django.livenessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.django.livenessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.django.livenessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.django.livenessProbe.failureThreshold }}
        readinessProbe:
          httpGet:
            path: {{ .Values.django.readinessProbe.path }}
            port: {{ .Values.django.port }}
            httpHeaders:
            - name: Host
              value: localhost
          initialDelaySeconds: {{ .Values.django.readinessProbe.initialDelaySeconds }}
          periodSeconds: {{ .Values.django.readinessProbe.periodSeconds }}
          timeoutSeconds: {{ .Values.django.readinessProbe.timeoutSeconds }}
          failureThreshold: {{ .Values.django.readinessProbe.failureThreshold }}
        resources:
          {{- toYaml .Values.django.resources | nindent 10 }}

      volumes:
      - name: static-files
        emptyDir: {}
      - name: migrations-storage
        persistentVolumeClaim:
          claimName: migrations-pvc
      - name: shared-migrations
        emptyDir: {}
