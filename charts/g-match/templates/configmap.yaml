apiVersion: v1
kind: ConfigMap
metadata:
  name: g-match-config
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "g-match.labels" . | nindent 4 }}
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-10"
    "helm.sh/hook-delete-policy": never
data:
  DEBUG: {{ .Values.config.debug | quote }}
  ALLOWED_HOSTS: {{ .Values.config.allowedHosts | quote }}
  STATIC_ROOT: {{ .Values.config.staticRoot | quote }}
  CSRF_ENABLED: {{ .Values.config.csrfEnabled | quote }}

  DB_NAME: {{ .Values.config.db.name | quote }}
  DB_USER: {{ .Values.config.db.user | quote }}
  DB_HOST: {{ include "g-match.mysql.host" . | quote }}
  DB_PORT: {{ .Values.config.db.port | quote }}

  REDIS_HOST: {{ include "g-match.redis.host" . | quote }}
  REDIS_PORT: {{ .Values.config.redis.port | quote }}

  FRONTEND_URL: {{ .Values.config.frontend.url | quote }}
  FRONTEND_AUTH_CALLBACK_URL: {{ .Values.config.frontend.authCallbackUrl | quote }}

  GIST_OIDC_CLIENT_ID: {{ .Values.config.gistOidc.clientId | quote }}
  GIST_OIDC_REDIRECT_URI: {{ .Values.config.gistOidc.redirectUri | quote }}
  GIST_OIDC_POST_LOGOUT_REDIRECT_URI: {{ .Values.config.gistOidc.postLogoutRedirectUri | quote }}
  # PKCE 비활성화 시 모바일 환경에서 redirect loop 문제 해결 가능
  GIST_OIDC_USE_PKCE: {{ .Values.config.gistOidc.usePkce | quote }}

  # SMTP Email settings
  SMTP_HOST: {{ include "g-match.smtp.host" . | quote }}
  SMTP_PORT: {{ .Values.smtp.port | quote }}
  SMTP_USE_TLS: {{ .Values.smtp.useTls | quote }}
  DEFAULT_FROM_EMAIL: {{ .Values.smtp.defaultFromEmail | quote }}

  # Terms & Privacy Policy URLs (S3 hosted markdown files)
  TERMS_OF_SERVICE_URL: {{ .Values.config.terms.termsOfServiceUrl | quote }}
  PRIVACY_POLICY_URL: {{ .Values.config.terms.privacyPolicyUrl | quote }}
