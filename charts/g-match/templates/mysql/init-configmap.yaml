{{- if .Values.mysql.enabled }}
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-init-scripts
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "g-match.labels" . | nindent 4 }}
    component: database
  annotations:
    "helm.sh/hook": pre-install,pre-upgrade
    "helm.sh/hook-weight": "-6"
    "helm.sh/hook-delete-policy": never
data:
  01-grant-network-access.sh: |
    #!/bin/bash
    # Grant access from 10.0.0.0/8 (Kubernetes pod network)
    mysql -u root -p"${MYSQL_ROOT_PASSWORD}" <<EOF
    CREATE USER IF NOT EXISTS '{{ .Values.config.db.user }}'@'10.%' IDENTIFIED BY '${MYSQL_PASSWORD}';
    GRANT ALL PRIVILEGES ON \`{{ .Values.config.db.name }}\`.* TO '{{ .Values.config.db.user }}'@'10.%';
    FLUSH PRIVILEGES;
    EOF
{{- end }}
